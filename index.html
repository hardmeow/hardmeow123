<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私人视频相册</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // Tailwind 配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#EC4899',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .video-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .recorder-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-dark min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md fixed w-full top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-video-camera text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">私人视频相册</h1>
            </div>
            <div class="flex space-x-4">
                <button id="exportBtn" class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                    <i class="fa fa-download mr-2"></i>导出
                </button>
                <label for="importFile" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center cursor-pointer transition-all">
                    <i class="fa fa-upload mr-2"></i>导入
                    <input id="importFile" type="file" accept=".txt" class="hidden">
                </label>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-24 pb-16">
        <!-- 录制区域 -->
        <section class="mb-12 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-circle text-secondary mr-2"></i>视频录制
            </h2>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-2/3">
                    <div id="videoContainer" class="relative bg-gray-900 rounded-lg overflow-hidden aspect-video">
                        <video id="preview" class="w-full h-full object-cover" autoplay muted></video>
                        <div id="recordingIndicator" class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm hidden">
                            <i class="fa fa-circle mr-1"></i>录制中
                        </div>
                        <div id="noCameraMessage" class="absolute inset-0 flex items-center justify-center text-white text-lg">
                            请点击开始录制按钮启用摄像头
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-1/3 flex flex-col justify-center gap-4">
                    <button id="startRecordBtn" class="bg-primary hover:bg-primary/90 text-white py-3 rounded-lg flex items-center justify-center text-lg transition-all">
                        <i class="fa fa-circle mr-2"></i>开始录制
                    </button>
                    <button id="stopRecordBtn" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg flex items-center justify-center text-lg transition-all hidden">
                        <i class="fa fa-stop mr-2"></i>停止录制
                    </button>
                    <button id="saveRecordBtn" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg flex items-center justify-center text-lg transition-all hidden">
                        <i class="fa fa-save mr-2"></i>保存录制
                    </button>
                    <div class="text-gray-500 text-sm">
                        <p><i class="fa fa-info-circle mr-1"></i> 支持电脑和手机摄像头录制</p>
                        <p><i class="fa fa-info-circle mr-1"></i> 可多次录制，所有视频将保存在相册中</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 相册展示区域 -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fa fa-th text-primary mr-2"></i>我的视频
                </h2>
                <span id="videoCount" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">0 个视频</span>
            </div>
            
            <div id="albumContainer" class="video-grid">
                <!-- 视频卡片将通过JS动态添加 -->
                <div id="emptyState" class="col-span-full py-16 text-center">
                    <i class="fa fa-film text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">相册还是空的，开始录制你的第一个视频吧！</p>
                </div>
            </div>
        </section>
    </main>

    <!-- 视频预览模态框 -->
    <div id="videoModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="relative w-full max-w-4xl">
            <button id="closeModalBtn" class="absolute -top-12 right-0 text-white text-2xl hover:text-gray-300 transition-colors">
                <i class="fa fa-times"></i>
            </button>
            <video id="modalVideo" class="w-full rounded-lg" controls></video>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p>私人视频相册 &copy; 2023</p>
            <p class="text-sm text-gray-400 mt-1">保护你的珍贵回忆</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let mediaRecorder;
        let recordedBlobs;
        let videos = [];
        const SPECIAL_SEPARATOR = '|||__VIDEO_SEPARATOR__|||'; // 特殊分隔符
        
        // DOM元素
        const preview = document.getElementById('preview');
        const startRecordBtn = document.getElementById('startRecordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const noCameraMessage = document.getElementById('noCameraMessage');
        const albumContainer = document.getElementById('albumContainer');
        const videoCount = document.getElementById('videoCount');
        const emptyState = document.getElementById('emptyState');
        const videoModal = document.getElementById('videoModal');
        const modalVideo = document.getElementById('modalVideo');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 尝试从本地存储加载视频
            loadVideosFromStorage();
            updateVideoCount();
            
            // 事件监听
            startRecordBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            saveRecordBtn.addEventListener('click', saveRecording);
            closeModalBtn.addEventListener('click', closeModal);
            exportBtn.addEventListener('click', exportAllVideos);
            importFile.addEventListener('change', importVideos);
            
            // 点击模态框背景关闭
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) {
                    closeModal();
                }
            });
        });
        
        // 开始录制
        async function startRecording() {
            try {
                // 获取媒体流
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: true
                });
                
                // 显示预览
                preview.srcObject = stream;
                noCameraMessage.classList.add('hidden');
                
                // 准备录制
                recordedBlobs = [];
                const options = { mimeType: 'video/webm; codecs=vp9,opus' };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    console.error('创建MediaRecorder失败:', e);
                    alert('无法启动录制，请确保你的浏览器支持WebM格式');
                    return;
                }
                
                // 开始录制
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        recordedBlobs.push(event.data);
                    }
                };
                
                mediaRecorder.start();
                recordingIndicator.classList.remove('hidden');
                startRecordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                
                console.log('录制开始');
            } catch (e) {
                console.error('获取媒体设备失败:', e);
                alert('无法访问摄像头或麦克风，请确保已授予权限');
            }
        }
        
        // 停止录制
        function stopRecording() {
            if (!mediaRecorder) return;
            
            mediaRecorder.stop();
            recordingIndicator.classList.add('hidden');
            stopRecordBtn.classList.add('hidden');
            saveRecordBtn.classList.remove('hidden');
            
            // 停止所有轨道
            if (preview.srcObject) {
                preview.srcObject.getTracks().forEach(track => track.stop());
            }
            
            console.log('录制停止');
        }
        
        // 保存录制
        function saveRecording() {
            if (!recordedBlobs || recordedBlobs.length === 0) return;
            
            // 创建视频Blob
            const videoBlob = new Blob(recordedBlobs, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(videoBlob);
            
            // 创建视频对象
            const video = {
                id: Date.now(),
                url: videoUrl,
                blob: videoBlob,
                timestamp: new Date().toISOString()
            };
            
            // 添加到视频列表
            videos.unshift(video);
            
            // 更新UI
            addVideoToAlbum(video);
            updateVideoCount();
            saveVideosToStorage();
            
            // 重置录制状态
            saveRecordBtn.classList.add('hidden');
            startRecordBtn.classList.remove('hidden');
            preview.srcObject = null;
            noCameraMessage.classList.remove('hidden');
            
            console.log('视频已保存');
        }
        
        // 添加视频到相册
        function addVideoToAlbum(video) {
            // 隐藏空状态
            if (videos.length === 1) {
                emptyState.classList.add('hidden');
            }
            
            // 创建视频卡片
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md overflow-hidden card-hover';
            card.dataset.id = video.id;
            
            // 格式化日期
            const date = new Date(video.timestamp);
            const formattedDate = date.toLocaleString();
            
            card.innerHTML = `
                <div class="relative aspect-video bg-gray-100">
                    <video class="w-full h-full object-cover" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 120' %3E%3Crect width='200' height='120' fill='%23f3f4f6'/%3E%3Ccircle cx='100' cy='60' r='20' fill='%239ca3af'/%3E%3Cpolygon points='90,45 90,75 115,60' fill='white'/%3E%3C/svg%3E">
                        <source src="${video.url}" type="video/webm">
                    </video>
                    <button class="play-btn absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity">
                        <i class="fa fa-play text-white text-4xl"></i>
                    </button>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-500 mb-2">${formattedDate}</p>
                    <div class="flex justify-between items-center">
                        <button class="delete-btn text-red-500 hover:text-red-700 transition-colors">
                            <i class="fa fa-trash-o"></i> 删除
                        </button>
                        <span class="text-xs text-gray-400">视频</span>
                    </div>
                </div>
            `;
            
            // 添加事件监听
            card.querySelector('.play-btn').addEventListener('click', () => {
                openVideoModal(video.url);
            });
            
            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteVideo(video.id);
            });
            
            // 添加到相册容器
            albumContainer.insertBefore(card, albumContainer.firstChild);
        }
        
        // 打开视频模态框
        function openVideoModal(videoUrl) {
            modalVideo.src = videoUrl;
            videoModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭视频模态框
        function closeModal() {
            modalVideo.pause();
            modalVideo.src = '';
            videoModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // 删除视频
        function deleteVideo(id) {
            if (confirm('确定要删除这个视频吗？')) {
                // 从数组中移除
                videos = videos.filter(video => video.id !== id);
                
                // 从DOM中移除
                const card = document.querySelector(`[data-id="${id}"]`);
                if (card) {
                    card.remove();
                }
                
                // 更新UI
                updateVideoCount();
                saveVideosToStorage();
                
                // 显示空状态
                if (videos.length === 0) {
                    emptyState.classList.remove('hidden');
                }
            }
        }
        
        // 更新视频计数
        function updateVideoCount() {
            videoCount.textContent = `${videos.length} 个视频`;
        }
        
        // 保存视频到本地存储
        function saveVideosToStorage() {
            // 由于Blob不能直接存储，我们将视频转换为base64
            const videosData = videos.map(video => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        resolve({
                            id: video.id,
                            base64: reader.result.split(',')[1], // 移除data URL前缀
                            timestamp: video.timestamp
                        });
                    };
                    reader.readAsDataURL(video.blob);
                });
            });
            
            Promise.all(videosData).then(data => {
                localStorage.setItem('privateAlbumVideos', JSON.stringify(data));
            });
        }
        
        // 从本地存储加载视频
        function loadVideosFromStorage() {
            const videosData = localStorage.getItem('privateAlbumVideos');
            if (videosData) {
                const parsedData = JSON.parse(videosData);
                
                parsedData.forEach(data => {
                    // 将base64转换回Blob
                    const byteCharacters = atob(data.base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    // 创建视频对象
                    const video = {
                        id: data.id,
                        url: url,
                        blob: blob,
                        timestamp: data.timestamp
                    };
                    
                    videos.push(video);
                    addVideoToAlbum(video);
                });
            }
        }
        
        // 导出所有视频
        function exportAllVideos() {
            if (videos.length === 0) {
                alert('相册中没有视频可导出');
                return;
            }
            
            // 1. 将视频转换为MPC格式（这里模拟转换，实际是WebM）
            // 注：浏览器中没有真正的MPC格式转换能力，这里使用WebM作为替代
            const mpcConversions = videos.map(video => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // 模拟MPC格式转换，实际上只是存储base64
                        resolve({
                            id: video.id,
                            mpcData: reader.result.split(',')[1] // 移除data URL前缀
                        });
                    };
                    reader.readAsDataURL(video.blob);
                });
            });
            
            Promise.all(mpcConversions).then(mpcFiles => {
                // 2. 转换为TXT格式（本质上是将base64视为文本）
                const txtFiles = mpcFiles.map(mpc => mpc.mpcData);
                
                // 3. 用特殊分隔符拼接
                const combinedTxt = txtFiles.join(SPECIAL_SEPARATOR);
                
                // 4. 创建下载
                const blob = new Blob([combinedTxt], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `video_album_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });
        }
        
        // 导入视频
        function importVideos(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // 1. 读取TXT内容
                    const content = e.target.result;
                    
                    // 2. 按分隔符拆分
                    const txtFiles = content.split(SPECIAL_SEPARATOR);
                    
                    if (txtFiles.length === 0) {
                        alert('导入的文件不包含任何视频数据');
                        return;
                    }
                    
                    // 3. 转换回MPC格式（模拟）并还原为视频
                    txtFiles.forEach((txtData, index) => {
                        try {
                            // 模拟从MPC转换回视频
                            const byteCharacters = atob(txtData);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'video/webm' });
                            const url = URL.createObjectURL(blob);
                            
                            // 创建视频对象
                            const video = {
                                id: Date.now() + index, // 确保ID唯一
                                url: url,
                                blob: blob,
                                timestamp: new Date().toISOString()
                            };
                            
                            // 添加到视频列表
                            videos.unshift(video);
                            addVideoToAlbum(video);
                        } catch (err) {
                            console.error('导入视频失败:', err);
                            alert(`部分视频导入失败: ${err.message}`);
                        }
                    });
                    
                    // 更新UI
                    updateVideoCount();
                    saveVideosToStorage();
                    alert(`成功导入 ${txtFiles.length} 个视频`);
                } catch (err) {
                    console.error('导入失败:', err);
                    alert(`导入失败: ${err.message}`);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入，允许重复选择同一个文件
            importFile.value = '';
        }
    </script>
</body>
</html>
